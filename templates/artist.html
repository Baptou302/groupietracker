<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{.Artist.Name}} ¬∑ Groupie Tracker</title>
    <link rel="stylesheet" href="/static/CSS/styles.css">
    <link rel="stylesheet" href="/static/CSS/artist.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- PayPal SDK -->
    {{if .PayPalClientID}}
    <script src="https://www.paypal.com/sdk/js?client-id={{.PayPalClientID}}&currency=EUR"></script>
    {{end}}
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  </head>
  <body>
    <header class="headerArtist">
      <div class="container detail-headerArtist">
        <div>
          <a class="back" href="/">‚Üê Retour</a>
          <h1 class="brand">{{.Artist.Name}}</h1>
          <p>Membres&nbsp;: {{joinMembers .Artist.Members}}</p>
        </div>
        <div class="meta">
          <p>Cr√©ation&nbsp;: {{.Artist.CreationDate}}</p>
          <p>Premier album&nbsp;: {{formatDate .Artist.FirstAlbum}}</p>
          <p>Nombre de concerts connus&nbsp;: {{len .Artist.ConcertDates}}</p>
        </div>
      </div>
    </header>
    <main class="container detail">
      <section class="hero">
        <div>
          <img src="{{.Artist.Image}}" alt="Photo de {{.Artist.Name}}">
        </div>
        <div class="hero-body">
          <h2>üìç Localisations r√©f√©renc√©es</h2>
          <ul>
            {{range .Artist.Locations}}
            <li>{{formatLocation .}}</li>
            {{else}}
            <li>Aucune information disponible.</li>
            {{end}}
          </ul>
          <h2>üìÖ Dates de concerts</h2>
          <ul class="dates">
            {{range .Artist.ConcertDates}}
            <li>{{formatDate .}}</li>
            {{else}}
            <li>Aucune date publi√©e.</li>
            {{end}}
          </ul>
        </div>
      </section>
      <section>
        <h2>üó∫Ô∏è Carte des concerts</h2>
        {{if .LocationsCoords}}
        <div id="map-container" style="width: 100%; height: 500px; margin: 2rem 0; border-radius: 1rem; overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid var(--border-light);">
          <div id="map" style="width: 100%; height: 100%;"></div>
        </div>
        <script>
          // Attendre que le DOM soit charg√© et que Leaflet soit disponible
          document.addEventListener('DOMContentLoaded', function() {
            // Donn√©es des emplacements avec coordonn√©es
            const locationsData = [
              {{range .LocationsCoords}}
              {
                location: {{printf "%q" .Location}},
                lat: {{printf "%.6f" .Coordinates.Latitude}},
                lon: {{printf "%.6f" .Coordinates.Longitude}},
                dates: [
                  {{range $index, $date := .Dates}}{{if $index}}, {{end}}{{printf "%q" (formatDate $date)}}{{end}}
                ]
              },
              {{end}}
            ];
            
            // Filtrer les emplacements avec des coordonn√©es valides
            const validLocations = locationsData.filter(loc => loc.lat !== 0 || loc.lon !== 0);
            
            if (validLocations.length > 0 && typeof L !== 'undefined') {
              // Initialiser la carte Leaflet
              const map = L.map('map').setView([validLocations[0].lat, validLocations[0].lon], 3);
              
              // Ajouter la couche de tuiles OpenStreetMap
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
              }).addTo(map);
              
              // Grouper les marqueurs pour les emplacements proches
              const markers = L.markerClusterGroup();
              
              // Ajouter un marqueur pour chaque emplacement
              validLocations.forEach(function(loc) {
                const popupContent = `
                  <div style="padding: 0.5rem;">
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--foreground); font-size: 1.1rem;">${loc.location}</h3>
                    <p style="margin: 0.25rem 0; color: var(--muted); font-size: 0.9rem;">
                      <strong>${loc.dates.length}</strong> concert${loc.dates.length > 1 ? 's' : ''}
                    </p>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem; color: var(--foreground); font-size: 0.85rem;">
                      ${loc.dates.map(date => `<li>${date}</li>`).join('')}
                    </ul>
                  </div>
                `;
                
                const marker = L.marker([loc.lat, loc.lon]);
                marker.bindPopup(popupContent);
                markers.addLayer(marker);
              });
              
              map.addLayer(markers);
              
              // Ajuster la vue pour inclure tous les marqueurs
              if (validLocations.length > 1) {
                const bounds = markers.getBounds();
                if (bounds.isValid()) {
                  map.fitBounds(bounds, { padding: [50, 50] });
                }
              }
            } else if (validLocations.length === 0) {
              // Afficher un message si aucun emplacement valide
              document.getElementById('map-container').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted);">Aucune coordonn√©e g√©ographique disponible.</div>';
            } else {
              // Erreur de chargement de Leaflet
              document.getElementById('map-container').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted);">Erreur de chargement de la carte.</div>';
            }
          });
        </script>
        {{else}}
        <p class="empty">Aucune localisation disponible pour la carte.</p>
        {{end}}
      </section>
      <section>
        <h2>üé´ Acheter des billets</h2>
        {{if .LocationDates}}
        <div class="ticket-purchase" style="margin: 2rem 0;">
          {{range .LocationDates}}
          <div class="ticket-card" style="background: var(--card); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border-light);">
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
              <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--foreground); font-size: 1.25rem;">{{.Pretty}}</h3>
                <p style="margin: 0.25rem 0; color: var(--muted); font-size: 0.9rem;">
                  <strong>{{.Count}}</strong> concert{{if ne .Count 1}}s{{end}} disponible{{if ne .Count 1}}s{{end}}
                </p>
                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem; color: var(--foreground-secondary); font-size: 0.85rem;">
                  {{range $index, $date := .Dates}}{{if lt $index 3}}
                  <li>{{formatDate $date}}</li>
                  {{end}}{{end}}
                  {{if gt (len .Dates) 3}}
                  <li style="color: var(--muted);">... et {{sub (len .Dates) 3}} autre{{if gt (sub (len .Dates) 3) 1}}s{{end}}</li>
                  {{end}}
                </ul>
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end;">
                <div style="text-align: right;">
                  <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">Prix unitaire</p>
                  <p style="margin: 0; color: var(--gold); font-size: 1.5rem; font-weight: 700;">{{printf "%.2f" 50.00}}‚Ç¨</p>
                </div>
                <div id="paypal-button-container-{{.Raw}}" data-artist-id="{{$.Artist.ID}}" data-location="{{.Raw}}" data-price="50.00"></div>
              </div>
            </div>
          </div>
          {{end}}
        </div>
        {{else}}
        <p class="empty">Aucun concert disponible pour l'achat de billets.</p>
        {{end}}
      </section>
      <section>
        <h2>üìã Relation dates / lieux</h2>
        {{if .LocationDates}}
        <div class="relations">
          {{range .LocationDates}}
          <article>
            <header>
              <strong>{{.Pretty}}</strong>
              <span>{{.Count}} date{{if ne .Count 1}}s{{end}}</span>
            </header>
            <ul>
              {{range .Dates}}
              <li>{{formatDate .}}</li>
              {{else}}
              <li>Aucune date disponible.</li>
              {{end}}
            </ul>
          </article>
          {{end}}
        </div>
        {{else}}
        <p class="empty">Aucune relation g√©ographique disponible.</p>
        {{end}}
      </section>
    </main>
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-links">
          <a href="/legal/conditions">Conditions g√©n√©rales de vente</a>
          <a href="/legal/privacy">Vos informations personnelles</a>
          <a href="/legal/cookies">Cookies</a>
          <a href="/legal/mentions">Mentions l√©gales</a>
        </div>
        <div class="footer-copyright">
          <p>¬© 2025, Groupie Tracker. Tous droits r√©serv√©s.</p>
          <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--muted);">Propuls√© par l'API <a href="https://groupietrackers.herokuapp.com/api" style="color: var(--gold);">Groupie Tracker</a></p>
        </div>
      </div>
    </footer>
    <script>
      // Configuration PayPal
      const PAYPAL_CLIENT_ID = '{{.PayPalClientID}}';
      
      // Fonction pour cr√©er un bouton PayPal pour chaque emplacement
      function initPayPalButtons() {
        const buttons = document.querySelectorAll('[id^="paypal-button-container-"]');
        
        buttons.forEach(container => {
          const artistId = container.getAttribute('data-artist-id');
          const location = container.getAttribute('data-location');
          const price = parseFloat(container.getAttribute('data-price'));
          
          if (typeof paypal !== 'undefined' && paypal.Buttons) {
            paypal.Buttons({
              createOrder: function(data, actions) {
                return fetch('/api/paypal/create-order', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    artist_id: parseInt(artistId),
                    location: location,
                    quantity: 1,
                    amount: price
                  })
                })
                .then(response => response.json())
                .then(data => {
                  if (data.approve_url) {
                    window.location.href = data.approve_url;
                    return data.order_id;
                  }
                  return data.order_id;
                })
                .catch(error => {
                  console.error('Erreur cr√©ation commande:', error);
                  alert('Erreur lors de la cr√©ation de la commande');
                });
              },
              style: {
                color: 'gold',
                shape: 'rect',
                label: 'pay',
                height: 40
              }
            }).render('#' + container.id);
          } else {
            // Fallback: bouton simple si PayPal SDK n'est pas charg√©
            container.innerHTML = `
              <button onclick="buyTicket(${artistId}, '${location}', ${price})" 
                      style="padding: 0.75rem 1.5rem; background: var(--gradient-gold); 
                             color: var(--bg); border: none; border-radius: 0.75rem; 
                             font-weight: 600; cursor: pointer;">
                Acheter pour ${price}‚Ç¨
              </button>
            `;
          }
        });
      }
      
      // Fonction fallback pour l'achat
      function buyTicket(artistId, location, price) {
        fetch('/api/paypal/create-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            artist_id: artistId,
            location: location,
            quantity: 1,
            amount: price
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.approve_url) {
            window.location.href = data.approve_url;
          } else {
            alert('Erreur lors de la cr√©ation de la commande');
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur lors de la cr√©ation de la commande');
        });
      }
      
      // Initialiser les boutons PayPal quand le DOM est pr√™t
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPayPalButtons);
      } else {
        initPayPalButtons();
      }
    </script>
  </body>
</html>

